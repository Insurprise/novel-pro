<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的私人导航站</title>
    <style>
        :root {
            --bg-color: #f4f6f9;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --border-color: #e8e8e8;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --danger-color: #dc3545;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        #app {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg-color);
            padding: 1rem 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .navbar .logo { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); }
        .navbar .nav-links button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem 1rem;
            margin-left: 1rem;
            font-size: 1rem;
            color: var(--primary-color);
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .navbar .nav-links button:hover { background-color: #f0f2f5; }
        .navbar .nav-links .logout-btn { color: var(--danger-color); }
        .form-container {
            max-width: 400px;
            margin: 4rem auto;
            padding: 2rem;
            background: var(--card-bg-color);
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .form-container h2 { text-align: center; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:hover { background-color: var(--primary-hover); }
        .form-switch { text-align: center; margin-top: 1rem; }
        .form-switch a { color: var(--primary-color); cursor: pointer; text-decoration: none; }
        .error-message { color: var(--danger-color); text-align: center; margin-bottom: 1rem; }
        .link-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .link-card {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .link-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); }
        .link-card h3 { margin-top: 0; }
        .link-card a {
            display: block;
            text-decoration: none;
            color: var(--primary-color);
            margin-top: 0.5rem;
            word-break: break-all;
            padding: 5px; border-radius: 3px;
        }
        .link-card a:hover { background-color: #f0f2f5; }
        .link-card small { color: #666; }
        .admin-panel { margin-bottom: 3rem; }
        .admin-panel table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg-color);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .admin-panel th, .admin-panel td { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        .admin-panel th { background-color: #f8f9fa; }
        .admin-panel td { word-break: break-all; }
        .admin-panel .actions button {
            margin-right: 0.5rem;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .admin-panel .edit-btn { border-color: #ffc107; background: #fff; color: #ffc107; }
        .admin-panel .delete-btn { border-color: var(--danger-color); background: #fff; color: var(--danger-color); }
        .add-btn {
            display: inline-block;
            margin: 2rem 0;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px;
            border: 1px solid #888; width: 80%; max-width: 500px;
            border-radius: 10px;
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .feature-placeholder {
            padding: 2rem;
            text-align: center;
            background: var(--card-bg-color);
            border-radius: 10px;
            margin-top: 2rem;
            border: 2px dashed var(--border-color);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const app = document.getElementById('app');
        const apiBase = '/api';

        const auth = {
            token: localStorage.getItem('token'),
            user: JSON.parse(localStorage.getItem('user')),
            set(token, user) {
                this.token = token; this.user = user;
                localStorage.setItem('token', token); localStorage.setItem('user', JSON.stringify(user));
            },
            clear() {
                this.token = null; this.user = null;
                localStorage.removeItem('token'); localStorage.removeItem('user');
            },
            isLoggedIn() { return !!this.token; },
            isAdmin() { return this.user && this.user.role === 'admin'; }
        };

        async function apiRequest(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (auth.token) { headers['Authorization'] = `Bearer ${auth.token}`; }
            const options = { method, headers };
            if (body) { options.body = JSON.stringify(body); }
            try {
                const response = await fetch(apiBase + endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                if (response.status === 204) return null;
                return response.json();
            } catch (error) {
                alert(`API Error: ${error.message}`);
                if (error.message.includes("未授权")) { auth.clear(); main(); }
                throw error;
            }
        }
        
        function renderNavbar() {
            const loggedIn = auth.isLoggedIn();
            const isAdmin = auth.isAdmin();
            let links = '';
            if (loggedIn) {
                links += `<button onclick="router.navigate('/')">导航主页</button>`;
                if (isAdmin) {
                    links += `<button onclick="router.navigate('/admin')">管理面板</button>`;
                }
                links += `<button onclick="router.navigate('/novel')">小说阅读</button>`;
                links += `<button class="logout-btn" onclick="logout()">登出 (${auth.user.username})</button>`;
            } else {
                links += `<button onclick="router.navigate('/login')">登录 / 注册</button>`;
            }
            return `<nav class="navbar"><div class="logo">导航站</div><div class="nav-links">${links}</div></nav>`;
        }
        
        function renderLoginPage(isRegister = false) {
             app.innerHTML = renderNavbar() + `
                <div class="form-container">
                    <div id="error-message" class="error-message"></div>
                    <h2>${isRegister ? '创建账户' : '登录'}</h2>
                    <form onsubmit="event.preventDefault(); ${isRegister ? 'handleRegister()' : 'handleLogin()'}">
                        <div class="form-group"><label for="username">用户名</label><input type="text" id="username" required></div>
                        <div class="form-group"><label for="password">密码</label><input type="password" id="password" required></div>
                        <button type="submit" class="btn">${isRegister ? '注册' : '登录'}</button>
                    </form>
                    <div class="form-switch">
                        ${isRegister ? `已经有账户了？ <a onclick="router.navigate('/login')">在此登录</a>` : `还没有账户？ <a onclick="router.navigate('/register')">立即注册</a>`}
                    </div>
                </div>`;
        }
        
        async function renderHomePage() {
            if (!auth.isLoggedIn()) { router.navigate('/login'); return; }
            app.innerHTML = renderNavbar() + `<h2>导航链接</h2><div id="link-grid" class="link-grid">加载中...</div>`;
            const links = await apiRequest('/navlinks');
            const grid = document.getElementById('link-grid');
            if (links.length === 0) { grid.innerHTML = "<p>管理员尚未添加任何链接。</p>"; return; }
            grid.innerHTML = links.map(link => {
                const mainDomain = `${link.subdomain}.20100505.xyz`;
                return `<div class="link-card"><h3>${link.name}</h3><a href="https://${mainDomain}" target="_blank"><strong>主站:</strong> ${mainDomain}</a></div>`;
            }).join('');
        }

        async function renderAdminPage() {
            if (!auth.isAdmin()) { router.navigate('/'); return; }
            app.innerHTML = renderNavbar() + `
                <div class="admin-panel">
                    <h2>管理导航链接</h2>
                    <button class="add-btn" onclick="showLinkModal()">+ 添加新链接</button>
                    <table>
                        <thead><tr><th>名称</th><th>子域名 (xxx)</th><th>操作</th></tr></thead>
                        <tbody id="links-table-body"></tbody>
                    </table>
                </div>

                <div class="admin-panel">
                    <h2>管理小说</h2>
                    <button class="add-btn" onclick="showNovelModal()">+ 添加新小说</button>
                    <table>
                        <thead><tr><th>ID</th><th>标题</th><th>作者</th><th>操作</th></tr></thead>
                        <tbody id="novels-table-body"></tbody>
                    </table>
                </div>

                <div id="link-modal" class="modal"><div class="modal-content">
                    <span class="close-btn" onclick="closeLinkModal()">&times;</span>
                    <h3 id="link-modal-title">添加新链接</h3>
                    <form onsubmit="event.preventDefault(); handleSaveLink();">
                        <input type="hidden" id="link-id">
                        <div class="form-group"><label for="link-name">网站名称</label><input type="text" id="link-name" required></div>
                        <div class="form-group"><label for="link-subdomain">子域名 (xxx)</label><input type="text" id="link-subdomain" required></div>
                        <button type="submit" class="btn">保存</button>
                    </form>
                </div></div>

                <div id="novel-modal" class="modal"><div class="modal-content">
                    <span class="close-btn" onclick="closeNovelModal()">&times;</span>
                    <h3 id="novel-modal-title">添加新小说</h3>
                    <form onsubmit="event.preventDefault(); handleSaveNovel();">
                        <input type="hidden" id="novel-is-edit">
                        <div class="form-group"><label for="novel-id">小说 ID (例如 'santi')</label><input type="text" id="novel-id" required></div>
                        <div class="form-group"><label for="novel-title">标题</label><input type="text" id="novel-title" required></div>
                        <div class="form-group"><label for="novel-author">作者</label><input type="text" id="novel-author"></div>
                        <div class="form-group"><label for="novel-description">简介</label><textarea id="novel-description" rows="3"></textarea></div>
                        <button type="submit" class="btn">保存</button>
                    </form>
                </div></div>
            `;
            loadAdminData();
        }

        async function loadAdminData() {
            const [links, novels] = await Promise.all([apiRequest('/navlinks'), apiRequest('/novels')]);
            
            const linksTableBody = document.getElementById('links-table-body');
            linksTableBody.innerHTML = links.map(link => `
                <tr>
                    <td>${link.name}</td><td>${link.subdomain}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick='showLinkModal(${link.id}, "${link.name}", "${link.subdomain}")'>编辑</button>
                        <button class="delete-btn" onclick="handleDeleteLink(${link.id})">删除</button>
                    </td>
                </tr>`).join('');
            
            const novelsTableBody = document.getElementById('novels-table-body');
            novelsTableBody.innerHTML = novels.map(novel => `
                <tr>
                    <td>${novel.id}</td><td>${novel.title}</td><td>${novel.author || ''}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick='showNovelModal("${novel.id}", "${novel.title}", "${novel.author || ''}", "${novel.description || ''}")'>编辑</button>
                        <button class="delete-btn" onclick='handleDeleteNovel("${novel.id}")'>删除</button>
                    </td>
                </tr>`).join('');
        }

        function renderNovelPage() {
            app.innerHTML = renderNavbar() + `
                <div class="feature-placeholder">
                    <h2>小说阅读与收藏功能</h2>
                    <p>这里将是您的小说阅读器界面。</p>
                    <p>我们已经完成了管理小说的后台。下一步骤将是在这里展示小说列表，并点击进入阅读界面。</p>
                </div>`;
        }
        
        async function handleLogin() {
            try {
                const data = await apiRequest('/login', 'POST', { username: username.value, password: password.value });
                auth.set(data.token, data.user); router.navigate('/');
            } catch(e) { document.getElementById('error-message').innerText = e.message; }
        }
        async function handleRegister() {
            try {
                await apiRequest('/register', 'POST', { username: username.value, password: password.value });
                alert('注册成功！请现在登录。'); router.navigate('/login');
            } catch(e) { document.getElementById('error-message').innerText = e.message; }
        }
        function logout() { auth.clear(); router.navigate('/login'); }

        function showLinkModal(id = null, name = '', subdomain = '') {
            document.getElementById('link-id').value = id;
            document.getElementById('link-name').value = name;
            document.getElementById('link-subdomain').value = subdomain;
            document.getElementById('link-modal-title').innerText = id ? '编辑链接' : '添加新链接';
            document.getElementById('link-modal').style.display = 'flex';
        }
        function closeLinkModal() { document.getElementById('link-modal').style.display = 'none'; }
        async function handleSaveLink() {
            const id = document.getElementById('link-id').value;
            const name = document.getElementById('link-name').value;
            const subdomain = document.getElementById('link-subdomain').value;
            const method = id ? 'PUT' : 'POST';
            const endpoint = id ? `/navlinks/${id}` : '/navlinks';
            await apiRequest(endpoint, method, { name, subdomain });
            closeLinkModal(); loadAdminData();
        }
        async function handleDeleteLink(id) {
            if (confirm('确定要删除这个链接吗？')) { await apiRequest(`/navlinks/${id}`, 'DELETE'); loadAdminData(); }
        }

        function showNovelModal(id = null, title = '', author = '', description = '') {
            const isEdit = id !== null;
            document.getElementById('novel-is-edit').value = isEdit ? 'true' : '';
            document.getElementById('novel-id').value = id || '';
            document.getElementById('novel-id').readOnly = isEdit;
            document.getElementById('novel-title').value = title;
            document.getElementById('novel-author').value = author;
            document.getElementById('novel-description').value = description;
            document.getElementById('novel-modal-title').innerText = isEdit ? '编辑小说' : '添加新小说';
            document.getElementById('novel-modal').style.display = 'flex';
        }
        function closeNovelModal() { document.getElementById('novel-modal').style.display = 'none'; }
        async function handleSaveNovel() {
            const isEdit = document.getElementById('novel-is-edit').value === 'true';
            const id = document.getElementById('novel-id').value;
            const title = document.getElementById('novel-title').value;
            const author = document.getElementById('novel-author').value;
            const description = document.getElementById('novel-description').value;

            const method = isEdit ? 'PUT' : 'POST';
            const endpoint = isEdit ? `/novels/${id}` : '/novels';
            
            await apiRequest(endpoint, method, { id, title, author, description });
            closeNovelModal(); loadAdminData();
        }
        async function handleDeleteNovel(id) {
            if (confirm(`确定要删除小说 "${id}" 吗？`)) { await apiRequest(`/novels/${id}`, 'DELETE'); loadAdminData(); }
        }

        const router = {
            routes: {
                '/': renderHomePage,
                '/login': () => renderLoginPage(false),
                '/register': () => renderLoginPage(true),
                '/admin': renderAdminPage,
                '/novel': renderNovelPage
            },
            navigate(path) { window.location.hash = path; },
            handle() {
                const path = window.location.hash.slice(1) || '/';
                const handler = this.routes[path] || this.routes['/']; handler();
            }
        };

        function main() {
            window.addEventListener('hashchange', () => router.handle());
            router.handle();
        }
        main();
    </script>
</body>
</html>