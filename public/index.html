<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的私人导航站 - 管理中心</title>
    <style>
        :root { --primary-color: #007bff; --primary-hover-color: #0056b3; --danger-color: #dc3545; --danger-hover-color: #c82333; --success-color: #28a745; --warning-color: #ffc107; --text-color: #333; --body-bg-color: #f8f9fa; --card-bg-color: #fff; --border-color: #dee2e6; --shadow-color: rgba(0, 0, 0, 0.05); --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif; }
        body { font-family: var(--font-family); margin: 0; background-color: var(--body-bg-color); color: var(--text-color); line-height: 1.6; }
        #app { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg-color); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px var(--shadow-color); margin-bottom: 2rem; }
        .navbar .logo { font-size: 1.5rem; font-weight: bold; text-decoration: none; color: var(--primary-color); }
        .navbar .nav-links a { margin-left: 1.5rem; text-decoration: none; color: var(--text-color); font-weight: 500; }
        .btn { padding: 0.5rem 1rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; transition: background-color 0.2s; text-align: center; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .content-section, .admin-section { background-color: var(--card-bg-color); padding: 2rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 4px 12px var(--shadow-color); }
        h2 { margin-top: 0; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: 600; }
        td.actions { white-space: nowrap; }
        .actions button, .actions .btn { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .form-container { width: 100%; max-width: 400px; margin: 2rem auto; background: var(--card-bg-color); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); overflow: hidden; }
        .form-content { padding: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1040; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 500px; z-index: 1050; }
        #announcement-bar { margin-bottom: 1rem; }
        .announcement { background-color: var(--warning-color); color: #333; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; }
        .hidden { display: none !important; }
        h3.favorite-novel-title { margin-top: 1.5rem; margin-bottom: 0.8rem; font-size: 1.2em; }
        .favorite-list a { display: block; padding: 0.7rem 0; border-bottom: 1px solid #f0f0f0; text-decoration: none; color: var(--link-color); }
        @media (max-width: 768px) { #app { padding: 1rem; } .navbar { flex-direction: column; align-items: flex-start; } table thead { display: none; } table tr { border: 1px solid var(--border-color); border-radius: 8px; display: block; margin-bottom: 1.2rem; } table td { display: block; text-align: right; border-bottom: 1px solid #f0f0f0; } table td::before{ content: attr(data-label); float: left; font-weight: bold; } }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-container" class="hidden"></div>
    <script>
        const app = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');
        const apiBase = '/api';
        const auth = { _token: null, _user: null, init() { this._token = localStorage.getItem('token'); try { this._user = JSON.parse(localStorage.getItem('user')); } catch (e) { this._user = null; } }, get() { return { token: this._token, user: this._user }; }, set(token, user) { this._token = token; this._user = user; localStorage.setItem('token', token); localStorage.setItem('user', JSON.stringify(user)); }, clear() { this._token = null; this._user = null; localStorage.removeItem('token'); localStorage.removeItem('user'); }, isLoggedIn() { return !!this._token; }, isAdmin() { return this.isLoggedIn() && this._user?.role === 'admin'; } };
        async function apiRequest(endpoint, method = 'GET', body = null) { const { token } = auth.get(); if (!token && !endpoint.startsWith('/login') && !endpoint.startsWith('/register')) { router.navigate('/login'); throw new Error('Not authenticated'); } const headers = { 'Content-Type': 'application/json' }; if (token) headers['Authorization'] = `Bearer ${token}`; const options = { method, headers, body: body ? JSON.stringify(body) : null }; const response = await fetch(`${apiBase}${endpoint}`, options); if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(errorData.error || `HTTP ${response.status}`); } return response.status === 204 ? null : response.json(); }
        const renderNavbar = () => { const { user } = auth.get(); const navLinks = [auth.isLoggedIn() && { path: '#/', text: '小说中心' }, auth.isAdmin() && { path: '#/admin', text: '管理面板' }, auth.isLoggedIn() ? { path: '#/logout', text: `登出 (${user?.username})` } : { path: '#/login', text: '登录' }].filter(Boolean); return `<div class="navbar"><a href="#/" class="logo">我的导航站</a><div class="nav-links">${navLinks.map(l => `<a href="${l.path}">${l.text}</a>`).join('')}</div></div>`; };
        const renderHomePage = async () => { if (!auth.isLoggedIn()) { router.navigate('/login'); return; } app.innerHTML = renderNavbar() + `<div id="announcement-bar"></div><div class="content-section"><h2>我的书库</h2><div id="novels-grid"></div></div><div class="content-section"><h2>我的收藏</h2><div id="favorites-list"></div></div>`; fetchAndRenderAnnouncements(); fetchAndRenderFavorites(); try { const novels = await apiRequest('/sites?type=novel'); document.getElementById('novels-grid').innerHTML = novels.length ? novels.map(n => `<div class="novel-card" style="border-bottom:1px solid #eee; padding-bottom:1rem; margin-bottom:1rem;"><h3>${n.name}</h3><p>${n.author || ''}</p><p>${n.description || ''}</p><a href="https://${n.subdomain}.20100505.xyz" class="btn btn-primary" target="_blank">开始阅读</a></div>`).join('') : '<p>书库为空。</p>'; } catch (error) { document.getElementById('novels-grid').innerHTML = `<p style="color:red;">加载书库失败: ${error.message}</p>`; } };
        async function fetchAndRenderFavorites() { const container = document.getElementById('favorites-list'); if (!container) return; try { const favorites = await apiRequest('favorites'); if (!favorites.length) { container.innerHTML = '<p>暂无收藏。</p>'; return; } const grouped = favorites.reduce((acc, fav) => { (acc[fav.novel_name] = acc[fav.novel_name] || []).push(fav); return acc; }, {}); let html = ''; for (const novelName in grouped) { html += `<h3 class="favorite-novel-title">${novelName}</h3><div class="favorite-list">`; grouped[novelName].sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(fav => { html += `<a href="https://${fav.novel_id}.20100505.xyz/?chapter=${fav.chapter_ind}" target="_blank">${fav.chapter_title}</a>`; }); html += `</div>`; } container.innerHTML = html; } catch (error) { container.innerHTML = `<p style="color:red;">加载收藏失败: ${error.message}</p>`; } }
        const renderAdminPage = async () => { if (!auth.isAdmin()) { router.navigate('/'); return; } app.innerHTML = renderNavbar() + `<div class="admin-section"><h2>站点管理</h2><button class="btn btn-primary" onclick="showSiteModal()">+ 添加新站点</button><div class="table-wrapper"><table><thead><tr><th>名称</th><th>子域名</th><th>类型</th><th>操作</th></tr></thead><tbody id="sites-table"></tbody></table></div></div><div class="admin-section"><h2>用户管理</h2><div class="table-wrapper"><table><thead><tr><th>用户名</th><th>角色</th><th>状态</th><th>操作</th></tr></thead><tbody id="users-table"></tbody></table></div></div><div class="admin-section"><h2>发布公告</h2><form id="global-announcement-form"><div class="form-group"><label>公告内容</label><textarea id="global-announcement" rows="3" required></textarea></div><button type="submit" class="btn btn-primary">发布</button></form></div>`; loadAdminData(); document.getElementById('global-announcement-form').onsubmit = handleSendGlobalAnnouncement; };
        const loadAdminData = async () => { try { const [sites, users] = await Promise.all([apiRequest('/sites'), apiRequest('/users')]); document.getElementById('sites-table').innerHTML = sites.map(s => `<tr><td data-label="名称">${s.name}</td><td data-label="子域名">${s.subdomain}</td><td data-label="类型">${s.type}</td><td class="actions"><button class="btn" onclick='showSiteModal(${JSON.stringify(s)})'>编辑</button><button class="btn btn-danger" onclick="handleDeleteSite(${s.id})">删除</button></td></tr>`).join(''); document.getElementById('users-table').innerHTML = users.map(u => `<tr><td data-label="用户名">${u.username}</td><td data-label="角色">${u.role}</td><td data-label="状态" style="color:${u.status === 'banned'?'red':'green'}">${u.status}</td><td class="actions"><button class="btn" onclick='showUserPasswordModal(${u.id})'>改密</button><button class="btn ${u.status === 'active' ? 'btn-danger' : ''}" onclick='handleUserStatusChange(${u.id}, "${u.status === 'active' ? 'banned' : 'active'}")'>${u.status === 'active' ? '封禁' : '解封'}</button><button class="btn" onclick='handleUserRoleChange(${u.id}, "${u.role === 'user' ? 'admin' : 'user'}")'>${u.role === 'user' ? '设为管理' : '取消管理'}</button><button class="btn" onclick='showUserAnnounceModal(${u.id})'>私信</button><button class="btn btn-danger" onclick="handleDeleteUser(${u.id})">删除</button></td></tr>`).join(''); } catch (error) { alert(`加载管理数据失败: ${error.message}`); } };
        const handleLogin = async (e) => { e.preventDefault(); try { const { username, password } = e.target.elements; const data = await apiRequest('/login', 'POST', { username: username.value, password: password.value }); auth.set(data.token, data.user); router.navigate('/'); } catch (error) { alert(`登录失败: ${error.message}`); } };
        const renderAuthPage = () => { app.innerHTML = `<div class="form-container"><div class="form-content"><h2>登录</h2><form id="login-form"><div class="form-group"><label for="username">用户名</label><input type="text" id="username" name="username" required></div><div class="form-group"><label for="password">密码</label><input type="password" id="password" name="password" required></div><button type="submit" class="btn btn-primary" style="width:100%;">登录</button></form></div></div>`; document.getElementById('login-form').onsubmit = handleLogin; };
        const fetchAndRenderAnnouncements = async () => { const bar = document.getElementById('announcement-bar'); if (!bar) return; try { const announcements = await apiRequest('/announcements'); bar.innerHTML = announcements.length > 0 ? announcements.map(a => `<div class="announcement">${a.content}</div>`).join('') : ''; } catch (e) { console.error("无法加载公告:", e); } };
        async function handleSendGlobalAnnouncement(e) { e.preventDefault(); const content = document.getElementById('global-announcement').value; if (!content) return; try { await apiRequest('announcements', 'POST', { content: content, isGlobal: true }); alert('全局公告已发布'); document.getElementById('global-announcement').value = ''; } catch (error) { alert(`发布失败: ${error.message}`); } }
        const hideModal = () => modalContainer.classList.add('hidden');
        const showModal = (title, content, footer) => { modalContainer.innerHTML = `<div class="modal-backdrop"><div class="modal"><h3>${title}</h3><div class="modal-body">${content}</div><div style="text-align:right; margin-top: 1rem;">${footer}</div></div></div>`; modalContainer.classList.remove('hidden'); };
        const showSiteModal = (site = null) => { const content = `<form id="site-form"><input type="hidden" id="site-id" value="${site?.id || ''}"><div class="form-group"><label>名称</label><input type="text" id="site-name" value="${site?.name || ''}" required></div><div class="form-group"><label>子域名</label><input type="text" id="site-subdomain" value="${site?.subdomain || ''}" required></div><div class="form-group"><label>类型</label><select id="site-type"><option value="novel" ${site?.type === 'novel' ? 'selected' : ''}>小说</option></select></div></form>`; const footer = `<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleSaveSite()">保存</button>`; showModal(site ? '编辑站点' : '添加站点', content, footer); };
        const handleSaveSite = async () => { try { const id = document.getElementById('site-id').value; const body = { name: document.getElementById('site-name').value, subdomain: document.getElementById('site-subdomain').value, type: document.getElementById('site-type').value }; await apiRequest(id ? `/sites/${id}` : '/sites', id ? 'PUT' : 'POST', body); hideModal(); loadAdminData(); } catch (e) { alert(`保存失败: ${e.message}`); } };
        const handleDeleteSite = async (id) => { if (confirm('确定要删除这个站点吗？')) try { await apiRequest(`/sites/${id}`, 'DELETE'); loadAdminData(); } catch (e) { alert(`删除失败: ${e.message}`); } };
        const handleDeleteUser = async (id) => { if (confirm('确定要永久删除这个用户吗？')) try { await apiRequest(`/users/${id}`, 'DELETE'); loadAdminData(); } catch (e) { alert(`删除失败: ${e.message}`); } };
        const handleUserStatusChange = async (id, status) => { try { await apiRequest(`/users/${id}/status`, 'PUT', { status }); loadAdminData(); } catch (e) { alert(`操作失败: ${e.message}`); } };
        const handleUserRoleChange = async (id, role) => { try { await apiRequest(`/users/${id}/role`, 'PUT', { role }); loadAdminData(); } catch (e) { alert(`操作失败: ${e.message}`); } };
        const showUserPasswordModal = (id) => { const content = `<div class="form-group"><label>新密码</label><input type="password" id="new-pass" required></div>`; const footer = `<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleUserPasswordChange(${id})">修改</button>`; showModal('修改用户密码', content, footer); };
        const handleUserPasswordChange = async (id) => { const password = document.getElementById('new-pass').value; if (password) try { await apiRequest(`/users/${id}/password`, 'PUT', { password }); hideModal(); alert('密码修改成功'); } catch(e){ alert(`修改失败: ${e.message}`); } };
        const showUserAnnounceModal = (id) => { const content = `<div class="form-group"><label>私信内容</label><textarea id="private-announce" rows="3" required></textarea></div>`; const footer = `<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleSendPrivateAnnouncement(${id})">发送</button>`; showModal('发送私信', content, footer); };
        const handleSendPrivateAnnouncement = async (id) => { const content = document.getElementById('private-announce').value; if(content) try { await apiRequest('/announcements', 'POST', { userId: id, content }); hideModal(); alert('私信已发送'); } catch(e){ alert(`发送失败: ${e.message}`); } };
        const router = { routes: { '/': renderHomePage, '/login': renderAuthPage, '/logout': () => { auth.clear(); router.navigate('/login'); },'/admin': renderAdminPage }, navigate(path) { window.location.hash = path; }, handler() { const path = (window.location.hash.replace('#', '') || '/').split('?')[0]; (this.routes[path] || this.routes['/'])(); } };
        auth.init(); router.handler(); window.addEventListener('hashchange', () => router.handler());
    </script>
</body>
</html>
