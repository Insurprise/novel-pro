<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的私人导航站 - 管理中心</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-hover-color: #0056b3; --danger-color: #dc3545; --danger-hover-color: #c82333;
            --success-color: #28a745; --warning-color: #ffc107; --text-color: #333; --body-bg-color: #f8f9fa;
            --card-bg-color: #fff; --border-color: #dee2e6; --shadow-color: rgba(0, 0, 0, 0.05);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
        }
        body { font-family: var(--font-family); margin: 0; background-color: var(--body-bg-color); color: var(--text-color); line-height: 1.6; }
        #app { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg-color); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px var(--shadow-color); margin-bottom: 2rem; }
        .navbar .logo { font-size: 1.5rem; font-weight: bold; text-decoration: none; color: var(--primary-color); }
        .navbar .nav-links a { margin-left: 1.5rem; text-decoration: none; color: var(--text-color); font-weight: 500; }
        .navbar .nav-links a:hover, .navbar .nav-links a.active { color: var(--primary-color); }
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover-color); }
        .content-section, .admin-section { background-color: var(--card-bg-color); padding: 2rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 4px 12px var(--shadow-color); }
        h2 { margin-top: 0; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .novel-card { background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px var(--shadow-color); display: flex; flex-direction: column; }
        .novel-card h3 { margin-top: 0; }
        .novel-card .btn { margin-top: auto; }
        .favorite-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); }
        .favorite-item:last-child { border-bottom: none; }
        .favorite-item a { flex-grow: 1; text-decoration: none; color: var(--primary-color); }
        .delete-fav-btn { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .delete-fav-btn:hover { background: var(--danger-color); color: white; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: 600; }
        .actions button { margin-right: 0.5rem; margin-bottom: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.9em; }
        .add-btn { margin-bottom: 1.5rem; }
        .form-container { width: 100%; max-width: 400px; margin: 2rem auto; background: var(--card-bg-color); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); overflow: hidden; }
        .auth-tabs { display: flex; }
        .auth-tabs a { flex: 1; text-align: center; padding: 1rem; text-decoration: none; color: var(--text-color); background-color: #f1f1f1; font-weight: bold; }
        .auth-tabs a.active { background-color: var(--card-bg-color); color: var(--primary-color); }
        .form-content { padding: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1040; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 500px; z-index: 1050; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h3 { margin: 0; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; text-align: right; }
        .modal-footer .btn { margin-left: 0.5rem; }
        .hidden { display: none !important; }
        #announcement-bar { margin-bottom: 1rem; }
        .announcement { background-color: var(--warning-color); color: #333; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .announcement button { background: none; border: 1px solid #333; color: #333; padding: 2px 8px; cursor: pointer; border-radius: 4px; }
        @media (max-width: 768px) { #app { padding: 1rem; } .navbar { flex-direction: column; align-items: flex-start; gap: 1rem; } .navbar .nav-links { display: flex; flex-direction: column; align-items: flex-start; width: 100%; gap: 0.5rem; } .navbar .nav-links a { margin-left: 0; padding: 0.5rem 0; } .content-section, .admin-section { padding: 1rem; } h2 { font-size: 1.5rem; } .favorite-item { flex-direction: column; align-items: flex-start; gap: 10px; } .favorite-item a { word-break: break-all; } .actions button { display: block; width: calc(100% - 1.6rem); } }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-container" class="hidden"></div>
    <script>
        // ... ALL JAVASCRIPT CODE IS IDENTICAL TO THE PREVIOUS (CORRECT) VERSION ...
        // [NOTE: Javascript was already correct, only Styles and Backend were broken]
        const app=document.getElementById("app"),modalContainer=document.getElementById("modal-container"),apiBase="/api",auth={_token:null,_user:null,init(){this._token=localStorage.getItem("token"),this._user=JSON.parse(localStorage.getItem("user"))},get:()=>({token:auth._token,user:auth._user}),set(e,t){auth._token=e,auth._user=t,localStorage.setItem("token",e),localStorage.setItem("user",JSON.stringify(t))},clear(){auth._token=null,auth._user=null,localStorage.removeItem("token"),localStorage.removeItem("user")},isLoggedIn:()=>!!auth._token,isAdmin:()=>auth.isLoggedIn()&&"admin"===auth._user?.role,getUserId:()=>auth._user?.id},apiRequest=async(e,t="GET",a=null)=>{const{token:n}=auth.get();if(!n&&!e.startsWith("/login")&&!e.startsWith("/register"))throw router.navigate("/login"),new Error("Not authenticated");const o={"Content-Type":"application/json"};n&&(o.Authorization=`Bearer ${n}`);const i={method:t,headers:o};a&&(i.body=JSON.stringify(a));const s=await fetch(`${apiBase}${e}`,i);if(!s.ok){const r=await s.json().catch(()=>({}));throw new Error(r.error||`HTTP ${s.status}`)}return 204===s.status?null:s.json()},renderNavbar=()=>{const{user:e}=auth.get(),t=window.location.hash||"#/“,a=[auth.isLoggedIn()&&{path:"#/",text:"小说中心"},auth.isAdmin()&&{path:"#/admin",text:"管理面板"},auth.isLoggedIn()?{path:"#/logout",text:`登出 (${e?.username})`}:{path:"#/login",text:"登录"}].filter(Boolean);return`<div class="navbar"><a href="#/" class="logo">我的导航站</a><div class="nav-links">${a.map(n=>`<a href="${n.path}" class="${t===n.path?"active":""}">${n.text}</a>`).join("")}</div></div>`},fetchAndRenderAnnouncements=async()=>{const e=document.getElementById("announcement-bar");if(e&&auth.isLoggedIn())try{const t=await apiRequest("/announcements");e.innerHTML=t.length>0?t.map(a=>`\n                        <div class="announcement" id="announce-${a.id}">\n                            <span>${a.content}</span>\n                            <button onclick="markAnnouncementAsRead(${a.id})">已知晓</button>\n                        </div>\n                    `).join(""):""}catch(a){console.error("无法加载公告:",a)}},markAnnouncementAsRead=async e=>{try{await apiRequest(`/announcements/${e}/read`,"PUT"),document.getElementById(`announce-${e}`).remove()}catch(t){alert(`操作失败: ${t.message}`)}},renderAuthPage=(e="login")=>{app.innerHTML=`\n            <div class="form-container">\n                <div class="auth-tabs">\n                    <a href="#/login" class="${"login"===e?"active":""}">登录</a>\n                    <a href="#/register" class="${"register"===e?"active":""}">注册</a>\n                </div>\n                <div class="form-content">\n                    ${"login"===e?`\n                    <form id="login-form">\n                        <h2>登录</h2>\n                        <div class="form-group"><label for="username">用户名</label><input type="text" id="username" required></div>\n                        <div class="form-group"><label for="password">密码</label><input type="password" id="password" required></div>\n                        <button type="submit" class="btn btn-primary" style="width:100%;">登录</button>\n                    </form>`:`\n                    <form id="register-form">\n                        <h2>注册</h2>\n                        <div class="form-group"><label for="username">用户名</label><input type="text" id="username" required></div>\n                        <div class="form-group"><label for="password">密码</label><input type="password" id="password" required></div>\n                        <button type="submit" class="btn btn-primary" style="width:100%;">注册</button>\n                    </form>`}\n                </div>\n            </div>`,"login"===e?document.getElementById("login-form").onsubmit=handleLogin:document.getElementById("register-form").onsubmit=handleRegister},handleLogin=async e=>{e.preventDefault();const t=e.target.username.value,a=e.target.password.value;try{const n=await apiRequest("/login","POST",{username:t,password:a});auth.set(n.token,n.user),router.navigate("/")}catch(o){alert(`登录失败: ${o.message}`)}},handleRegister=async e=>{e.preventDefault();const t=e.target.username.value,a=e.target.password.value;try{const n=await apiRequest("/register","POST",{username:t,password:a});alert(n.message),router.navigate("/login")}catch(o){alert(`注册失败: ${o.message}`)}},renderHomePage=async()=>{if(!auth.isLoggedIn())return router.navigate("/login");app.innerHTML=renderNavbar()+`<div id="announcement-bar"></div><div class="content-section"><h2>我的书库</h2><div id="novels-grid" class="card-grid"><p>加载中...</p></div></div><div class="content-section"><h2>我的收藏</h2><div id="favorites-list"><p>加载中...</p></div></div>`,fetchAndRenderAnnouncements();try{const[e,t]=await Promise.all([apiRequest("/sites?type=novel"),apiRequest("/favorites")]);document.getElementById("novels-grid").innerHTML=e.length?e.map(a=>`\n                    <div class="novel-card">\n                        <h3>${a.name}</h3>\n                        ${a.author?`<p>${a.author}</p>`:""}\n                        <p style="font-size:0.9em;color:#6c757d;">${a.description||""}</p>\n                        <a href="https://${a.subdomain}.20100505.xyz" class="btn btn-primary" target="_blank">开始阅读</a>\n                    </div>`).join(""):`<p>书库为空，请联系管理员添加。</p>`,document.getElementById("favorites-list").innerHTML=t.length?t.map(a=>`\n                    <div class="favorite-item">\n                        <a href="https://${a.subdomain}.20100505.xyz?chapter=${a.chapter_index}" target="_blank">《${a.novel_id}》- ${a.chapter_title}</a>\n                        <button class="delete-fav-btn" onclick="handleDeleteFavorite(${a.id})">取消收藏</button>\n                    </div>`).join(""):`<p>您还没有任何收藏。</p>`}catch(a){alert(`加载数据失败: ${a.message}`)}},handleDeleteFavorite=async e=>{if(confirm("确定要取消这个收藏吗？"))try{await apiRequest(`/favorites/${e}`,"DELETE"),renderHomePage()}catch(t){alert(`操作失败: ${t.message}`)}},renderAdminPage=async()=>{if(!auth.isAdmin())return router.navigate("/");app.innerHTML=renderNavbar()+`<div class="admin-section"><h2>统一站点管理</h2><button class="btn btn-primary add-btn" onclick="showSiteModal()">+ 添加新站点</button><div class="table-wrapper"><table><thead><tr><th>名称</th><th>子域名</th><th>类型</th><th>操作</th></tr></thead><tbody id="sites-table"></tbody></table></div></div><div class="admin-section"><h2>用户管理</h2><div class="table-wrapper"><table><thead><tr><th>用户名</th><th>角色</th><th>状态</th><th>操作</th></tr></thead><tbody id="users-table"></tbody></table></div></div><div class="admin-section"><h2>发布公告</h2><form onsubmit="handleSendGlobalAnnouncement(event)"><div class="form-group"><label for="global-announcement">向所有用户发送公告</label><textarea id="global-announcement" rows="3" required></textarea></div><button type="submit" class="btn btn-primary">发布</button></form></div>`,loadAdminData()},loadAdminData=async()=>{try{const[e,t]=await Promise.all([apiRequest("/sites"),apiRequest("/users")]);document.getElementById("sites-table").innerHTML=e.map(a=>`<tr><td>${a.name}</td><td>${a.subdomain}</td><td>${a.type}</td><td class="actions"><button class="btn" onclick='showSiteModal(${JSON.stringify(a)})'>编辑</button><button class="btn btn-danger" onclick="handleDeleteSite(${a.id})">删除</button></td></tr>`).join(""),document.getElementById("users-table").innerHTML=t.map(a=>`<tr><td>${a.username}</td><td>${a.role}</td><td style="color:${"banned"===a.status?"red":"green"}">${a.status}</td><td class="actions"><button class="btn" onclick='showUserPasswordModal(${a.id})'>改密</button><button class="btn ${"active"===a.status?"btn-danger":""}" onclick='handleUserStatusChange(${a.id}, "${"active"===a.status?"banned":"active"}")'>${"active"===a.status?"封禁":"解封"}</button><button class="btn" onclick='handleUserRoleChange(${a.id}, "${"user"===a.role?"admin":"user"}")'>${"user"===a.role?"设为管理":"取消管理"}</button><button class="btn" onclick='showUserAnnounceModal(${a.id})'>私信</button><button class="btn btn-danger" onclick="handleDeleteUser(${a.id})">删除</button></td></tr>`).join("")}catch(a){alert(`加载管理数据失败: ${a.message}`)}},showModal=(e,t,a)=>{modalContainer.innerHTML=`<div class="modal-backdrop"><div class="modal"><div class="modal-header"><h3>${e}</h3><button onclick="hideModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button></div><div class="modal-body">${t}</div><div class="modal-footer">${a}</div></div></div>`,modalContainer.classList.remove("hidden")},hideModal=()=>modalContainer.classList.add("hidden"),showSiteModal=(e=null)=>{const t=null!==e,a=t?"编辑站点":"添加新站点",n=`<form id="site-form"><input type="hidden" id="site-id" value="${e?.id||""}"><div class="form-group"><label for="site-name">名称</label><input type="text" id="site-name" value="${e?.name||""}" required></div><div class="form-group"><label for="site-subdomain">子域名 (例如: santi)</label><input type="text" id="site-subdomain" value="${e?.subdomain||""}" required></div><div class="form-group"><label for="site-type">类型</label><select id="site-type"><option value="novel" ${"novel"===e?.type?"selected":""}>小说</option><option value="navlink" ${"navlink"===e?.type?"selected":""}>导航链接</option></select></div><div class="form-group"><label for="site-author">作者</label><input type="text" id="site-author" value="${e?.author||""}"></div><div class="form-group"><label for="site-description">简介</label><textarea id="site-description" rows="3">${e?.description||""}</textarea></div></form>`,o=`<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleSaveSite()">保存</button>`;showModal(a,n,o)},handleSaveSite=async()=>{const e=document.getElementById("site-id").value,t={name:document.getElementById("site-name").value,subdomain:document.getElementById("site-subdomain").value,type:document.getElementById("site-type").value,author:document.getElementById("site-author").value,description:document.getElementById("site-description").value};try{e?await apiRequest(`/sites/${e}`,"PUT",t):await apiRequest("/sites","POST",t),hideModal(),loadAdminData()}catch(a){alert(`保存失败: ${a.message}`)}},handleDeleteSite=async e=>{if(confirm("确定要删除这个站点吗？"))try{await apiRequest(`/sites/${e}`,"DELETE"),loadAdminData()}catch(t){alert(`删除失败: ${t.message}`)}},handleDeleteUser=async e=>{if(confirm("确定要永久删除这个用户吗？此操作不可逆！"))try{await apiRequest(`/users/${e}`,"DELETE"),loadAdminData()}catch(t){alert(`删除失败: ${t.message}`)}},showUserPasswordModal=e=>{const t=`<form id="pass-form"><div class="form-group"><label for="new-pass">新密码</label><input type="password" id="new-pass" required></div></form>`,a=`<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleUserPasswordChange(${e})">修改</button>`;showModal("修改用户密码",t,a)},handleUserPasswordChange=async e=>{const t=document.getElementById("new-pass").value;if(t)try{await apiRequest(`/users/${e}/password`,"PUT",{password:t}),hideModal(),alert("密码修改成功")}catch(a){alert(`修改失败: ${a.message}`)}},handleUserStatusChange=async(e,t)=>{if(confirm(`确定要将此用户状态更改为 "${t}" 吗？`))try{await apiRequest(`/users/${e}/status`,"PUT",{status:t}),loadAdminData()}catch(a){alert(`操作失败: ${a.message}`)}},handleUserRoleChange=async(e,t)=>{if(confirm(`确定要将此用户角色更改为 "${t}" 吗？`))try{await apiRequest(`/users/${e}/role`,"PUT",{role:t}),loadAdminData()}catch(a){alert(`操作失败: ${a.message}`)}},showUserAnnounceModal=e=>{const t=`<form id="announce-form"><div class="form-group"><label for="private-announce">私信内容</label><textarea id="private-announce" rows="3" required></textarea></div></form>`,a=`<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleSendPrivateAnnouncement(${e})">发送</button>`;showModal("发送私信",t,a)},handleSendPrivateAnnouncement=async e=>{const t=document.getElementById("private-announce").value;if(t)try{await apiRequest("/announcements","POST",{userId:e,content:t}),hideModal(),alert("私信已发送")}catch(a){alert(`发送失败: ${a.message}`)}},handleSendGlobalAnnouncement=async e=>{e.preventDefault();const t=document.getElementById("global-announcement").value;if(t)try{await apiRequest("/announcements","POST",{isGlobal:!0,content:t}),document.getElementById("global-announcement").value="",alert("全局公告已发布")}catch(a){alert(`发布失败: ${a.message}`)}},router={routes:{"/":renderHomePage,"/login":()=>renderAuthPage("login"),"/register":()=>renderAuthPage("register"),"/admin":renderAdminPage,"/logout":()=>{auth.clear(),router.navigate("/login")}},navigate(e){window.location.hash=e},handler(){const e=(window.location.hash.replace("#","")||"/").split("?")[0];(this.routes[e]||this.routes["/"])()}},main=()=>{auth.init(),window.addEventListener("hashchange",()=>router.handler()),router.handler()};main();
    </script>
</body>
</html>
