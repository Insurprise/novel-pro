<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的私人导航站</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 40px auto; padding: 30px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #1f2d3d; }
        #auth-section, #favorites-section, #nav-section { margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .grid-item { display: block; padding: 15px; background-color: #f8f9fa; border-radius: 5px; text-decoration: none; color: #495057; font-weight: 500; text-align: center; transition: all 0.2s ease-in-out; }
        .grid-item:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-color: #007bff; color: #fff; }
        #favorites-list li { list-style: none; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; transition: background-color 0.2s; }
        #favorites-list li:hover { background-color: #f1f3f5; }
        #favorites-list a { text-decoration: none; color: #007bff; }
        .delete-fav-btn { cursor: pointer; color: #dc3545; font-size: 14px; border: none; background: none; padding: 5px; }
        #user-info { float: right; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-section">
            <span id="user-info" style="display: none;">你好, <b id="username-display"></b>! <a href="#" onclick="logout()">退出</a></span>
            <form id="login-form"><h2>登录</h2><input type="text" id="username" placeholder="用户名" required><input type="password" id="password" placeholder="密码" required><button type="submit">登录</button></form>
        </div>
        <div id="nav-section" style="display: none;"><h2>我的书库</h2><div id="nav-links" class="grid"></div></div>
        <div id="favorites-section" style="display: none;">
            <h2>我的收藏</h2>
            <ul id="favorites-list" style="padding: 0;"></ul>
        </div>
    </div>
    <script>
        const API_BASE_URL = 'https://novel-pro.20100505.xyz/api';
        let apiToken = null;

        async function apiRequest(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (apiToken) headers['Authorization'] = `Bearer ${apiToken}`;
            const res = await fetch(`${API_BASE_URL}/${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
            if (!res.ok) throw new Error(await res.text());
            if (res.status === 204) return null;
            return res.json();
        }

        async function renderFavorites() {
            const listEl = document.getElementById('favorites-list');
            listEl.innerHTML = '';
            try {
                const favorites = await apiRequest('favorites');
                if (!favorites.length) {
                    listEl.innerHTML = '<li>暂无收藏。</li>';
                    return;
                }
                favorites.forEach(fav => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `https://${fav.novel_id}.20100505.xyz?chapter=${fav.chapter_index}`;
                    link.textContent = `${fav.novel_id} - ${fav.chapter_title}`;
                    link.target = "_blank";
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '删除';
                    deleteBtn.className = 'delete-fav-btn';
                    deleteBtn.onclick = async () => {
                        if (confirm(`确定要删除收藏《${fav.chapter_title}》吗？`)) {
                            await apiRequest('favorites', 'DELETE', { novel_id: fav.novel_id, chapter_id: fav.chapter_id });
                            renderFavorites(); // Re-render the list
                        }
                    };
                    li.appendChild(link);
                    li.appendChild(deleteBtn);
                    listEl.appendChild(li);
                });
            } catch (error) { listEl.innerHTML = '<li>加载收藏失败。</li>'; }
        }

        async function onLoginSuccess() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('nav-section').style.display = 'block';
            document.getElementById('favorites-section').style.display = 'block';
            document.getElementById('user-info').style.display = 'inline';
            const user = JSON.parse(atob(apiToken));
            document.getElementById('username-display').textContent = user.username;
            await renderFavorites();
            // 渲染书库导航（这里省略，保持原样）
        }
        
        // ... 其他登录、登出、检查状态的JS代码保持不变 ...
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); /* ... */ const username = e.target.username.value, password = e.target.password.value; try { const data = await apiRequest('login', 'POST', { username, password }); localStorage.setItem('token', data.token); apiToken = data.token; onLoginSuccess(); } catch (err) { alert('登录失败'); } });
        function logout() { localStorage.removeItem('token'); window.location.reload(); }
        function checkLoginStatus() { const token = localStorage.getItem('token'); if (token) { apiToken = token; onLoginSuccess(); } }
        checkLoginStatus();
    </script>
</body>
</html>
