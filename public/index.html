<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的私人导航站</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-hover-color: #0056b3; --danger-color: #dc3545; --danger-hover-color: #c82333;
            --success-color: #28a745; --warning-color: #ffc107; --text-color: #333; --body-bg-color: #f8f9fa;
            --card-bg-color: #fff; --border-color: #dee2e6; --shadow-color: rgba(0, 0, 0, 0.05);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
        }
        body { font-family: var(--font-family); margin: 0; background-color: var(--body-bg-color); color: var(--text-color); line-height: 1.6; }
        #app { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg-color); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px var(--shadow-color); margin-bottom: 1rem; }
        .navbar .logo { font-size: 1.5rem; font-weight: bold; text-decoration: none; color: var(--primary-color); }
        .navbar .nav-links a { margin-left: 1.5rem; text-decoration: none; color: var(--text-color); font-weight: 500; }
        .navbar .nav-links a:hover, .navbar .nav-links a.active { color: var(--primary-color); }
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover-color); }
        .content-section, .admin-section { background-color: var(--card-bg-color); padding: 2rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 4px 12px var(--shadow-color); }
        h2 { margin-top: 0; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .form-container { width: 100%; max-width: 400px; margin: 2rem auto; background: var(--card-bg-color); border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); overflow: hidden; }
        .auth-tabs { display: flex; }
        .auth-tabs a { flex: 1; text-align: center; padding: 1rem; text-decoration: none; color: var(--text-color); background-color: #f1f1f1; font-weight: bold; }
        .auth-tabs a.active { background-color: var(--card-bg-color); color: var(--primary-color); }
        .form-content { padding: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, textarea, select { width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        .hidden { display: none !important; }
        /* --- Announcement Bar --- */
        #announcement-bar { margin-bottom: 1rem; }
        .announcement { background-color: var(--warning-color); color: #333; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .announcement button { background: none; border: 1px solid #333; color: #333; padding: 2px 8px; cursor: pointer; border-radius: 4px; }
        /* Modal Styles */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1040; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 500px; z-index: 1050; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h3 { margin: 0; }
        .modal-footer { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; text-align: right; }
        @media (max-width: 768px) { #app { padding: 1rem; } .navbar { flex-direction: column; align-items: flex-start; gap: 1rem; } .navbar .nav-links { display: flex; flex-direction: column; align-items: flex-start; width: 100%; gap: 0.5rem; } .navbar .nav-links a { margin-left: 0; padding: 0.5rem 0; } .content-section, .admin-section { padding: 1rem; } }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-container" class="hidden"></div>

    <script>
        const app = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');
        const apiBase = '/api';
        const auth = { _token: null, _user: null, init() { this._token = localStorage.getItem('token'); this._user = JSON.parse(localStorage.getItem('user')); }, get() { return { token: this._token, user: this._user }; }, set(token, user) { this._token = token; this._user = user; localStorage.setItem('token', token); localStorage.setItem('user', JSON.stringify(user)); }, clear() { this._token = null; this._user = null; localStorage.removeItem('token'); localStorage.removeItem('user'); }, isLoggedIn() { return !!this._token; }, isAdmin() { return this.isLoggedIn() && this._user?.role === 'admin'; } };
        
        const apiRequest = async (endpoint, method = 'GET', body = null) => { const { token } = auth.get(); if (!token && !endpoint.startsWith('/login') && !endpoint.startsWith('/register')) { router.navigate('/login'); throw new Error('Not authenticated'); } const headers = { 'Content-Type': 'application/json' }; if(token) headers['Authorization'] = `Bearer ${token}`; const options = { method, headers }; if (body) { options.body = JSON.stringify(body); } const response = await fetch(`${apiBase}${endpoint}`, options); if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(errorData.error || `HTTP ${response.status}`); } return response.status === 204 ? null : response.json(); };
        const renderNavbar = () => { const { user } = auth.get(); const currentPath = window.location.hash || '#/'; const navLinks = [ auth.isLoggedIn() && { path: '#/', text: '小说中心' }, auth.isAdmin() && { path: '#/admin', text: '管理面板' }, auth.isLoggedIn() ? { path: '#/logout', text: `登出 (${user?.username})` } : { path: '#/login', text: '登录' } ].filter(Boolean); return `<div class="navbar"><a href="#/" class="logo">我的导航站</a><div class="nav-links">${navLinks.map(l => `<a href="${l.path}" class="${currentPath === l.path ? 'active' : ''}">${l.text}</a>`).join('')}</div></div>`; };
        
        const fetchAndRenderAnnouncements = async () => {
            const announcementBar = document.getElementById('announcement-bar');
            if (!announcementBar || !auth.isLoggedIn()) return;
            try {
                const announcements = await apiRequest('/announcements');
                if (announcements.length > 0) {
                    announcementBar.innerHTML = announcements.map(a => `
                        <div class="announcement" id="announce-${a.id}">
                            <span>${a.content}</span>
                            <button onclick="markAnnouncementAsRead(${a.id})">已知晓</button>
                        </div>
                    `).join('');
                } else {
                    announcementBar.innerHTML = '';
                }
            } catch (e) {
                console.error("无法加载公告:", e);
            }
        };

        const markAnnouncementAsRead = async (id) => {
            try {
                await apiRequest(`/announcements/${id}/read`, 'PUT');
                document.getElementById(`announce-${id}`).remove();
            } catch (e) {
                alert(`操作失败: ${e.message}`);
            }
        };

        const renderAuthPage = (page = 'login') => { app.innerHTML = `<div class="form-container"><div class="auth-tabs"><a href="#/login" class="${page === 'login' ? 'active' : ''}">登录</a><a href="#/register" class="${page === 'register' ? 'active' : ''}">注册</a></div><div class="form-content">${page === 'login' ? `<form id="login-form"><h2>登录</h2><div class="form-group"><label for="username">用户名</label><input type="text" id="username" required></div><div class="form-group"><label for="password">密码</label><input type="password" id="password" required></div><button type="submit" class="btn btn-primary" style="width:100%;">登录</button></form>` : `<form id="register-form"><h2>注册</h2><div class="form-group"><label for="username">用户名</label><input type="text" id="username" required></div><div class="form-group"><label for="password">密码</label><input type="password" id="password" required></div><button type="submit" class="btn btn-primary" style="width:100%;">注册</button></form>`}</div></div>`; if (page === 'login') { document.getElementById('login-form').onsubmit = handleLogin; } else { document.getElementById('register-form').onsubmit = handleRegister; } };
        const handleLogin = async (e) => { e.preventDefault(); const username = e.target.username.value; const password = e.target.password.value; try { const data = await apiRequest('/login', 'POST', { username, password }); auth.set(data.token, data.user); router.navigate('/'); } catch (error) { alert(`登录失败: ${error.message}`); } };
        const handleRegister = async (e) => { e.preventDefault(); const username = e.target.username.value; const password = e.target.password.value; try { const data = await apiRequest('/register', 'POST', { username, password }); alert(data.message); router.navigate('/login'); } catch (error) { alert(`注册失败: ${error.message}`); } };
        const renderHomePage = async () => { if (!auth.isLoggedIn()) { router.navigate('/login'); return; } app.innerHTML = renderNavbar() + `<div id="announcement-bar"></div><div class="content-section"><h2>我的书库</h2><div id="novels-grid" class="card-grid"><p>加载中...</p></div></div><div class="content-section"><h2>我的收藏</h2><div id="favorites-list"><p>加载中...</p></div></div>`; fetchAndRenderAnnouncements(); try { const [novels, favorites] = await Promise.all([apiRequest('/sites?type=novel'), apiRequest('/favorites')]); document.getElementById('novels-grid').innerHTML = novels.length ? novels.map(n => `<div class="card novel-card"><h3>${n.name}</h3><p>${n.description || ''}</p><a href="https://${n.subdomain}.20100505.xyz" class="btn btn-primary" target="_blank">开始阅读</a></div>`).join('') : '<p>书库为空。</p>'; document.getElementById('favorites-list').innerHTML = favorites.length ? favorites.map(f => `<div class="favorite-item"><a href="https://${f.subdomain}.20100505.xyz?chapter=${f.chapter_index}" target="_blank">《${f.novel_id}》- ${f.chapter_title}</a><button class="delete-fav-btn" onclick="handleDeleteFavorite(${f.id})">取消</button></div>`).join('') : '<p>您还没有任何收藏。</p>'; } catch (error) { alert(`加载数据失败: ${error.message}`); } };
        
        // --- Admin Functions ---
        const renderAdminPage = async () => { if (!auth.isAdmin()) { router.navigate('/'); return; } app.innerHTML = renderNavbar() + `<div class="admin-section"><h2>统一站点管理</h2><button class="btn btn-primary" onclick="showSiteModal()">+ 添加新站点</button><div style="overflow-x:auto;"><table><thead><tr><th>名称</th><th>子域名</th><th>类型</th><th>操作</th></tr></thead><tbody id="sites-table"></tbody></table></div></div><div class="admin-section"><h2>用户管理</h2><div style="overflow-x:auto;"><table><thead><tr><th>用户名</th><th>角色</th><th>状态</th><th>操作</th></tr></thead><tbody id="users-table"></tbody></table></div></div><div class="admin-section"><h2>发布公告</h2><form id="global-announcement-form"><div class="form-group"><label for="global-announcement">向所有用户发送公告</label><textarea id="global-announcement" rows="3" required></textarea></div><button type="submit" class="btn btn-primary">发布</button></form></div>`; loadAdminData(); document.getElementById('global-announcement-form').onsubmit = handleSendGlobalAnnouncement; };
        const loadAdminData = async () => { try { const [sites, users] = await Promise.all([apiRequest('/sites'), apiRequest('/users')]); document.getElementById('sites-table').innerHTML = sites.map(s => `<tr><td>${s.name}</td><td>${s.subdomain}</td><td>${s.type}</td><td><button onclick='showSiteModal(${JSON.stringify(s)})'>编辑</button><button onclick="handleDeleteSite(${s.id})">删除</button></td></tr>`).join(''); document.getElementById('users-table').innerHTML = users.map(u => `<tr><td>${u.username}</td><td>${u.role}</td><td>${u.status}</td><td><button onclick='showUserPasswordModal(${u.id})'>改密</button><button onclick='handleUserStatusChange(${u.id}, "${u.status === 'active' ? 'banned' : 'active'}")'>${u.status === 'active' ? '封禁' : '解封'}</button><button onclick='showUserAnnounceModal(${u.id})'>私信</button></td></tr>`).join(''); } catch (error) { alert(`加载管理数据失败: ${error.message}`); } };
        const showModal = (title, content, footer) => { modalContainer.innerHTML = `<div class="modal-backdrop"><div class="modal"><div class="modal-header"><h3>${title}</h3><button onclick="hideModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button></div><div class="modal-body">${content}</div><div class="modal-footer">${footer}</div></div></div>`; modalContainer.classList.remove('hidden'); }; const hideModal = () => modalContainer.classList.add('hidden');
        const showSiteModal = (site = null) => { const isEdit = site !== null; const title = isEdit ? '编辑站点' : '添加新站点'; const content = `<form id="site-form"><input type="hidden" id="site-id" value="${site?.id || ''}"><div class="form-group"><label for="site-name">名称</label><input type="text" id="site-name" value="${site?.name || ''}" required></div><div class="form-group"><label for="site-subdomain">子域名</label><input type="text" id="site-subdomain" value="${site?.subdomain || ''}" required></div><div class="form-group"><label for="site-type">类型</label><select id="site-type"><option value="novel" ${site?.type === 'novel' ? 'selected' : ''}>小说</option><option value="navlink" ${site?.type === 'navlink' ? 'selected' : ''}>导航链接</option></select></div></form>`; const footer = `<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleSaveSite()">保存</button>`; showModal(title, content, footer); };
        const handleSaveSite = async () => { const id = document.getElementById('site-id').value; const body = { name: document.getElementById('site-name').value, subdomain: document.getElementById('site-subdomain').value, type: document.getElementById('site-type').value }; try { if (id) await apiRequest(`/sites/${id}`, 'PUT', body); else await apiRequest('/sites', 'POST', body); hideModal(); loadAdminData(); } catch (e) { alert(`保存失败: ${e.message}`); } };
        const handleDeleteSite = async (id) => { if (confirm('确定要删除吗？')) try { await apiRequest(`/sites/${id}`, 'DELETE'); loadAdminData(); } catch (e) { alert(`删除失败: ${e.message}`); } };
        const showUserPasswordModal=(id)=>{const c=`<form id="pass-form"><div class="form-group"><label for="new-pass">新密码</label><input type="password" id="new-pass" required></div></form>`;const f=`<button onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleUserPasswordChange(${id})">修改</button>`;showModal('修改密码',c,f)};const handleUserPasswordChange = async (id)=>{const p=document.getElementById('new-pass').value;if(p)try{await apiRequest(`/users/${id}/password`,'PUT',{password:p});hideModal();alert('修改成功')}catch(e){alert(`修改失败: ${e.message}`)} };
        const handleUserStatusChange = async (id, status)=>{if(confirm(`确定要将状态改为"${status}"?`))try{await apiRequest(`/users/${id}/status`,'PUT',{status});loadAdminData()}catch(e){alert(`操作失败: ${e.message}`)} };
        const showUserAnnounceModal = (id) => { const content = `<form id="announce-form"><div class="form-group"><label for="private-announce">私信内容</label><textarea id="private-announce" rows="3" required></textarea></div></form>`; const footer = `<button class="btn" onclick="hideModal()">取消</button><button class="btn btn-primary" onclick="handleSendPrivateAnnouncement(${id})">发送</button>`; showModal('发送私信', content, footer); };
        const handleSendPrivateAnnouncement = async (id) => { const content = document.getElementById('private-announce').value; if(content) try { await apiRequest('/announcements', 'POST', {userId: id, content}); hideModal(); alert('私信已发送'); } catch(e){ alert(`发送失败: ${e.message}`); }};
        const handleSendGlobalAnnouncement = async (e) => { e.preventDefault(); const content = document.getElementById('global-announcement').value; if(content) try { await apiRequest('/announcements', 'POST', {isGlobal: true, content}); document.getElementById('global-announcement').value=''; alert('全局公告已发布'); } catch(e){ alert(`发布失败: ${e.message}`); }};

        const router = { routes: { '/': renderHomePage, '/login': () => renderAuthPage('login'), '/register': () => renderAuthPage('register'), '/admin': renderAdminPage, '/logout': () => { auth.clear(); router.navigate('/login'); } }, navigate(path) { window.location.hash = path; }, handler() { const path = window.location.hash.replace('#', '') || '/'; (this.routes[path] || this.routes['/'])(); } };
        
        const main = () => { auth.init(); window.addEventListener('hashchange', () => router.handler()); router.handler(); };
        main();
    </script>
</body>
</html>
